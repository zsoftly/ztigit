name: CI/CD Pipeline

# Efficient path-based triggering:
# - Go code changes → test + security jobs
# - Script changes → lint-scripts job
# - Docs/examples changes → no CI (skipped)
# - Tags → build + release jobs only

on:
  push:
    branches: [main, 'feature/*', 'feat/*', 'issue/*', 'release/*']
    tags:
      - '[0-9]*'
  pull_request:
    branches: [main, 'release/*']
  workflow_dispatch:

jobs:
  # Determine which jobs to run based on changed files
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/')
    outputs:
      go: ${{ steps.filter.outputs.go }}
      scripts: ${{ steps.filter.outputs.scripts }}
      workflow: ${{ steps.filter.outputs.workflow }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            go:
              - 'cmd/**'
              - 'internal/**'
              - 'pkg/**'
              - 'go.mod'
              - 'go.sum'
              - 'Makefile'
            scripts:
              - 'scripts/**'
            workflow:
              - '.github/workflows/**'

  lint-scripts:
    name: Lint Scripts
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.scripts == 'true' || needs.changes.outputs.workflow == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Lint shell scripts (shellcheck)
        run: |
          echo "Checking shell scripts with shellcheck..."
          shellcheck -x scripts/*.sh
          echo "Shell scripts passed shellcheck"

      - name: Validate shell script syntax
        run: |
          echo "Validating shell script syntax..."
          for script in scripts/*.sh; do
            bash -n "$script" || exit 1
          done
          echo "Shell script syntax is valid"

      - name: Lint PowerShell scripts (PSScriptAnalyzer)
        shell: pwsh
        run: |
          echo "Checking PowerShell scripts with PSScriptAnalyzer..."
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          $results = Invoke-ScriptAnalyzer -Path scripts/*.ps1 -Severity Error,Warning
          if ($results) {
            $results | Format-Table -AutoSize
            throw "PSScriptAnalyzer found issues"
          }
          echo "PowerShell scripts passed PSScriptAnalyzer"

      - name: Validate PowerShell script syntax
        shell: pwsh
        run: |
          echo "Validating PowerShell script syntax..."
          foreach ($script in Get-ChildItem scripts/*.ps1) {
            $null = [System.Management.Automation.Language.Parser]::ParseFile($script.FullName, [ref]$null, [ref]$errors)
            if ($errors) {
              Write-Error "Syntax errors in $($script.Name):"
              $errors | ForEach-Object { Write-Error $_.Message }
              exit 1
            }
          }
          echo "PowerShell script syntax is valid"

  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: changes
    if: needs.changes.outputs.go == 'true' || needs.changes.outputs.workflow == 'true'

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Get dependencies
        run: go mod download

      - name: Run tests
        run: go test -v ./...

      - name: Run go vet
        run: go vet ./...

      - name: Check formatting
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            git config core.autocrlf false
            git checkout HEAD -- .
          fi

          UNFORMATTED=$(gofmt -s -l .)
          if [ -n "$UNFORMATTED" ]; then
            echo "The following files are not formatted correctly:"
            echo "$UNFORMATTED"
            echo ""
            echo "Please run 'gofmt -s -w .' to fix formatting issues."
            exit 1
          fi
          echo "All Go files are properly formatted."

      - name: Test build
        run: go build -o ztigit${{ matrix.os == 'windows-latest' && '.exe' || '' }} ./cmd/ztigit

      - name: Test CLI commands
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            ZTIGIT_EXE="./ztigit.exe"
          else
            ZTIGIT_EXE="./ztigit"
          fi

          $ZTIGIT_EXE --help
          $ZTIGIT_EXE mirror --help
          $ZTIGIT_EXE --version

  security:
    name: Security Analysis
    runs-on: ubuntu-latest
    needs: [changes, test]
    if: |
      github.event_name == 'pull_request' &&
      github.base_ref == 'main' &&
      (needs.changes.outputs.go == 'true' || needs.changes.outputs.workflow == 'true')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Download dependencies
        run: go mod download

      - name: Install security tools
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.61.0

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'
        continue-on-error: true

      - name: Run golangci-lint with security checks
        run: $(go env GOPATH)/bin/golangci-lint run --enable gosec || true
        continue-on-error: true

      - name: Run Go vulnerability check
        run: govulncheck ./... || true
        continue-on-error: true

      - name: Run go vet
        run: go vet ./...

  # Build job - only on tags or manual dispatch
  build:
    name: Build (${{ matrix.goos }}-${{ matrix.goarch }})
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Get dependencies
        run: go mod download

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          GIT_COMMIT=${GITHUB_SHA::8}
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="dev-${GIT_COMMIT}"
          fi

          echo "Building version: ${VERSION}"

          BINARY_NAME="ztigit-${{ matrix.goos }}-${{ matrix.goarch }}"
          if [ "${{ matrix.goos }}" = "windows" ]; then
            BINARY_NAME="${BINARY_NAME}.exe"
          fi

          go build \
            -ldflags "-X main.version=${VERSION} -s -w" \
            -o "${BINARY_NAME}" \
            ./cmd/ztigit

          if [ "${{ matrix.goos }}" = "linux" ] && [ "${{ matrix.goarch }}" = "amd64" ]; then
            ./"${BINARY_NAME}" --version
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ztigit-${{ matrix.goos }}-${{ matrix.goarch }}
          path: ztigit-${{ matrix.goos }}-${{ matrix.goarch }}*
          retention-days: 30

  release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [build]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare release binaries
        run: |
          mkdir -p release/

          for dir in artifacts/*/; do
            platform=$(basename "$dir")
            cd "$dir"
            cp ./* "../../release/"
            if [[ "$platform" == *"windows"* ]]; then
              zip -r "../../release/${platform}.zip" ./*
            else
              tar -czf "../../release/${platform}.tar.gz" ./*
            fi
            cd - > /dev/null
          done

          cp scripts/install.sh release/
          cp scripts/install.ps1 release/

          echo "Release binaries:"
          ls -la release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
